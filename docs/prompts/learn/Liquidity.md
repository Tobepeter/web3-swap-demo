# 什么是流动性

流动性是指在金融市场中，资产或证券的买卖能力。它反映了资产或证券在市场中的可交易性，即在需要时能够以合理价格迅速转换为现金的能力。

流动性是金融市场的重要特征，对于投资者和市场参与者来说至关重要。高流动性意味着资产或证券可以更容易地买卖，价格波动较小，交易成本较低。

# 什么是流动性池

流动性池是Uniswap等去中心化交易所中的一个概念，它指的是一个包含两种代币的池子，用户可以在这个池子中提供流动性，即添加这两种代币的买卖能力。

流动性池中的两种代币被称为流动性提供者（LP），他们提供流动性，并获得流动性提供者代币（LP Token）作为奖励。

# 流动性份额计算

## 初始流动性

初始流动性提供者获得的LP代币数量计算公式为：

\[ LP = \sqrt{x \* y} \]

其中，x和y分别是流动性池中两种代币的数量。

使用几何平均数可以降低价格操纵的风险，开根号是为了弱化其中一个因子变化导致变化较大，如 x 是 1000，y 是 1，那么 LP = 1000，
这时候，y+9，就相当于 x+9000

## 追加流动性 (totalLiquidity > 0)

```solidity
liquidityMinted = Math.min(
    (amount0 * _totalLiquidity) / reserve0,
    (amount1 * _totalLiquidity) / reserve1
);
```

假设当前池子状态：

reserve0 = 100
reserve1 = 400
totalLiquidity = 200
如果用户想添加：

amount0 = 10
amount1 = 40

那么，用户获得的LP代币数量为：

token0 份额 = (10 \* 200) / 100 = 20
token1 份额 = (40 \* 200) / 400 = 20

为什么取最小值：

如果用户提供的两种代币比例不完全匹配当前池子比例
取最小值可以确保不会因为某个代币提供过多而扭曲池子的价格
这也激励用户按照正确的比例提供流动性

## 提取流动性

在 Uniswap V2 中，k 值检查（也称为恒定乘积公式）具有重要的数学和经济意义

k = x y，其中：
x 是代币A的储备量
y 是代币B的储备量
k 是一个恒定值

这是一个双曲线函数，表示为：\[ k = x y \]

任何交易后，新的储备量乘积必须大于或等于原来的k值：

(x + Δx) \* (y - Δy) >= k

公式展开：

```
(x + Δx)(y - Δy) = x * y

xy - xΔy + yΔx - ΔxΔy = xy

-xΔy + yΔx - ΔxΔy = 0

Δy = (yΔx)/(x + Δx)
```

对应 solidity

```solidity
uint256 amountInWithFee = amountIn * 997; // Δx 考虑 0.3% 手续费
uint256 numerator = amountInWithFee * reserveOut; // y * Δx
uint256 denominator = reserveIn * 1000 + amountInWithFee; // (x + Δx) * 1000
return numerator / denominator; // 得到 Δy
```

这意味着储备量乘积在任何交易后都不会减少，从而保持了池子的稳定性。

假设：

- 池子中有 1000 个代币A (x)
- 2000 个代币B (y)
- 则 k = 1000 \* 2000 = 2,000,000

如果有人要用A换B：

- 投入100个代币A
- 新的x = 1100
- 新的y必须满足：1100 \* y = 2,000,000
- 因此y = 1818.18
- 用户可以获得：2000 - 1818.18 = 181.82个代币B
